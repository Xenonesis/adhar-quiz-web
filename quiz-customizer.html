<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Quiz Generator - Gemini AI</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <h2>Custom Quiz Generator</h2>
      <div class="nav-icons">
        <button id="theme-toggle" class="btn-icon">üåô</button>
      </div>
      <div class="nav-links">
        <a href="index.html" class="btn-secondary nav-link">Standard Quiz</a>
        <a href="dashboard.html" class="btn-secondary nav-link">Dashboard</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>üéØ Custom Quiz Generator</h1>
    <p>Create personalized quizzes with Gemini AI on any topic!</p>

    <div id="quiz-setup" class="card">
      <h3>Quiz Configuration</h3>
      
      <div style="margin-bottom: 20px;">
        <label for="topic-input" style="display: block; margin-bottom: 5px; font-weight: 600;">Topic or Subject:</label>
        <input type="text" id="topic-input" placeholder="e.g., JavaScript Programming, World History, Biology..." 
               style="width: 100%; padding: 12px; border: 2px solid var(--color-border); border-radius: 8px; font-size: 16px;">
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div>
          <label for="question-count" style="display: block; margin-bottom: 5px; font-weight: 600;">Number of Questions:</label>
          <select id="question-count" style="width: 100%; padding: 12px; border: 2px solid var(--color-border); border-radius: 8px;">
            <option value="5">5 Questions</option>
            <option value="10" selected>10 Questions</option>
            <option value="15">15 Questions</option>
            <option value="20">20 Questions</option>
            <option value="25">25 Questions</option>
          </select>
        </div>

        <div>
          <label for="difficulty-level" style="display: block; margin-bottom: 5px; font-weight: 600;">Difficulty Level:</label>
          <select id="difficulty-level" style="width: 100%; padding: 12px; border: 2px solid var(--color-border); border-radius: 8px;">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <label for="custom-prompt" style="display: block; margin-bottom: 5px; font-weight: 600;">Custom Instructions (Optional):</label>
        <textarea id="custom-prompt" rows="4" placeholder="Add specific requirements, focus areas, or instructions for question generation..."
                  style="width: 100%; padding: 12px; border: 2px solid var(--color-border); border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
      </div>

      <div style="text-align: center;">
        <button id="generate-quiz" class="btn-primary" style="padding: 15px 30px; font-size: 16px;">
          üöÄ Generate Custom Quiz
        </button>
      </div>
    </div>

    <div class="progress-text" id="progress-text" style="display: none;">
      <span id="current-question">0</span> of <span id="total-questions">0</span> questions answered
    </div>
    <div class="progress-container" id="progress-container" style="display: none;">
      <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div id="quiz"></div>

    <div class="quiz-controls" id="quiz-controls" style="display: none;">
      <button id="reset" class="btn-warning">Reset Quiz</button>
      <button id="submit" class="btn-primary">Submit Quiz</button>
      <button id="new-custom-quiz" class="btn-secondary">New Custom Quiz</button>
    </div>

    <div id="results" class="hidden"></div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/gemini-api.js"></script>
  <script src="js/app.js"></script>
  
  <script>
    class CustomQuizApp {
      constructor() {
        this.questions = [];
        this.currentQuestionIndex = 0;
        this.userAnswers = [];
        this.score = 0;
        this.quizCompleted = false;
        this.geminiGenerator = null;
        
        this.initializeElements();
        this.initializeEventListeners();
        this.checkApiKey();
      }

      initializeElements() {
        this.quizSetup = document.getElementById('quiz-setup');
        this.quizContainer = document.getElementById('quiz');
        this.progressBar = document.getElementById('progress-bar');
        this.progressContainer = document.getElementById('progress-container');
        this.progressText = document.getElementById('progress-text');
        this.currentQuestionSpan = document.getElementById('current-question');
        this.totalQuestionsSpan = document.getElementById('total-questions');
        this.quizControls = document.getElementById('quiz-controls');
        this.resetButton = document.getElementById('reset');
        this.submitButton = document.getElementById('submit');
        this.newCustomQuizButton = document.getElementById('new-custom-quiz');
        this.resultsContainer = document.getElementById('results');
        this.generateButton = document.getElementById('generate-quiz');
      }

      initializeEventListeners() {
        this.generateButton.addEventListener('click', () => this.generateCustomQuiz());
        this.resetButton.addEventListener('click', () => this.resetQuiz());
        this.submitButton.addEventListener('click', () => this.submitQuiz());
        this.newCustomQuizButton.addEventListener('click', () => this.showQuizSetup());
      }

      checkApiKey() {
        if (!isApiKeyConfigured()) {
          this.showApiKeySetup();
          return;
        }
        this.geminiGenerator = new GeminiQuizGenerator(CONFIG.GEMINI_API_KEY);
      }

      showApiKeySetup() {
        this.quizSetup.innerHTML = `
          <h3>üîë API Key Setup Required</h3>
          <p>To generate custom questions with Gemini AI, you need to:</p>
          <ol>
            <li>Get a free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
            <li>Open <code>js/config.js</code> file</li>
            <li>Replace <code>YOUR_GEMINI_API_KEY_HERE</code> with your actual API key</li>
            <li>Refresh this page</li>
          </ol>
          <div style="margin-top: 20px;">
            <input type="text" id="temp-api-key" placeholder="Or paste your API key here temporarily" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <button onclick="customQuizApp.setTempApiKey()" class="btn-primary">Use This Key</button>
          </div>
        `;
      }

      setTempApiKey() {
        const tempKey = document.getElementById('temp-api-key').value.trim();
        if (tempKey) {
          CONFIG.GEMINI_API_KEY = tempKey;
          this.geminiGenerator = new GeminiQuizGenerator(tempKey);
          location.reload();
        }
      }

      async generateCustomQuiz() {
        const topic = document.getElementById('topic-input').value.trim();
        const questionCount = parseInt(document.getElementById('question-count').value);
        const difficulty = document.getElementById('difficulty-level').value;
        const customPrompt = document.getElementById('custom-prompt').value.trim();

        if (!topic) {
          alert('Please enter a topic for your quiz!');
          return;
        }

        try {
          this.showLoading();
          
          if (customPrompt) {
            const fullPrompt = `Topic: ${topic}\nDifficulty: ${difficulty}\nAdditional Instructions: ${customPrompt}`;
            this.questions = await this.geminiGenerator.generateCustomQuestions(fullPrompt, questionCount);
          } else {
            this.questions = await this.geminiGenerator.generateQuestions(topic, questionCount, difficulty);
          }
          
          if (this.questions.length === 0) {
            throw new Error('No valid questions generated');
          }
          
          this.startQuiz();
        } catch (error) {
          console.error('Error generating custom quiz:', error);
          this.showError('Failed to generate custom quiz. Please try again.');
        }
      }

      showLoading() {
        this.quizSetup.style.display = 'none';
        this.quizContainer.innerHTML = `
          <div class="card" style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">ü§ñ</div>
            <h3>Generating Your Custom Quiz...</h3>
            <div style="margin: 20px 0;">
              <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            <p>Creating personalized questions just for you!</p>
          </div>
        `;
      }

      showError(message) {
        this.quizContainer.innerHTML = `
          <div class="card" style="text-align: center; border-left: 4px solid #f44336;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <h3>Error</h3>
            <p>${message}</p>
            <button onclick="customQuizApp.showQuizSetup()" class="btn-primary" style="margin-top: 20px;">Try Again</button>
          </div>
        `;
      }

      startQuiz() {
        this.currentQuestionIndex = 0;
        this.userAnswers = [];
        this.score = 0;
        this.quizCompleted = false;
        
        this.quizSetup.style.display = 'none';
        this.progressContainer.style.display = 'block';
        this.progressText.style.display = 'block';
        this.quizControls.style.display = 'flex';
        
        this.totalQuestionsSpan.textContent = this.questions.length;
        this.updateProgress();
        this.displayQuestion();
        this.resultsContainer.classList.add('hidden');
      }

      showQuizSetup() {
        this.quizSetup.style.display = 'block';
        this.progressContainer.style.display = 'none';
        this.progressText.style.display = 'none';
        this.quizControls.style.display = 'none';
        this.quizContainer.innerHTML = '';
        this.resultsContainer.classList.add('hidden');
      }

      displayQuestion() {
        if (this.currentQuestionIndex >= this.questions.length) {
          this.submitQuiz();
          return;
        }

        const question = this.questions[this.currentQuestionIndex];
        const questionNumber = this.currentQuestionIndex + 1;

        this.quizContainer.innerHTML = `
          <div class="question-card card">
            <div class="question">
              <div class="question-number">${questionNumber}</div>
              <div>${question.question}</div>
            </div>
            <div class="answers">
              ${question.options.map((option, index) => `
                <label>
                  <input type="radio" name="question-${this.currentQuestionIndex}" value="${String.fromCharCode(65 + index)}">
                  ${option}
                </label>
              `).join('')}
            </div>
            <div style="margin-top: 20px; text-align: center;">
              ${this.currentQuestionIndex > 0 ? '<button onclick="customQuizApp.previousQuestion()" class="btn-secondary">Previous</button>' : ''}
              <button onclick="customQuizApp.nextQuestion()" class="btn-primary" style="margin-left: 10px;">Next</button>
            </div>
          </div>
        `;

        // Add event listeners for answer selection
        const radioButtons = this.quizContainer.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radio => {
          radio.addEventListener('change', (e) => {
            this.userAnswers[this.currentQuestionIndex] = e.target.value;
            const labels = this.quizContainer.querySelectorAll('label');
            labels.forEach(label => label.classList.remove('selected'));
            e.target.closest('label').classList.add('selected');
          });
        });

        // Restore previous answer if exists
        if (this.userAnswers[this.currentQuestionIndex]) {
          const previousAnswer = this.userAnswers[this.currentQuestionIndex];
          const radioToCheck = this.quizContainer.querySelector(`input[value="${previousAnswer}"]`);
          if (radioToCheck) {
            radioToCheck.checked = true;
            radioToCheck.closest('label').classList.add('selected');
          }
        }
      }

      nextQuestion() {
        if (this.currentQuestionIndex < this.questions.length - 1) {
          this.currentQuestionIndex++;
          this.updateProgress();
          this.displayQuestion();
        }
      }

      previousQuestion() {
        if (this.currentQuestionIndex > 0) {
          this.currentQuestionIndex--;
          this.updateProgress();
          this.displayQuestion();
        }
      }

      updateProgress() {
        const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
        this.progressBar.style.width = `${progress}%`;
        this.currentQuestionSpan.textContent = this.currentQuestionIndex + 1;
      }

      submitQuiz() {
        if (this.quizCompleted) return;

        this.calculateScore();
        this.displayResults();
        this.quizCompleted = true;
      }

      calculateScore() {
        this.score = 0;
        for (let i = 0; i < this.questions.length; i++) {
          if (this.userAnswers[i] === this.questions[i].answer) {
            this.score++;
          }
        }
      }

      displayResults() {
        const percentage = Math.round((this.score / this.questions.length) * 100);
        let grade = 'F';
        let message = 'Keep practicing!';
        
        if (percentage >= 90) {
          grade = 'A+';
          message = 'Excellent work! üéâ';
        } else if (percentage >= 80) {
          grade = 'A';
          message = 'Great job! üëè';
        } else if (percentage >= 70) {
          grade = 'B';
          message = 'Good work! üëç';
        } else if (percentage >= 60) {
          grade = 'C';
          message = 'Not bad, but you can do better! üí™';
        } else if (percentage >= 50) {
          grade = 'D';
          message = 'You need more practice. üìö';
        }

        this.resultsContainer.innerHTML = `
          <div class="card">
            <h2>Quiz Results</h2>
            <div style="text-align: center; margin: 20px 0;">
              <div style="font-size: 72px; margin-bottom: 10px;">${grade}</div>
              <div style="font-size: 24px; font-weight: 600; margin-bottom: 10px;">${percentage}%</div>
              <div style="font-size: 18px; color: var(--color-text-secondary);">${message}</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
              <div style="text-align: center; padding: 15px; background: var(--color-success); color: white; border-radius: 10px;">
                <div style="font-size: 24px; font-weight: 600;">${this.score}</div>
                <div>Correct</div>
              </div>
              <div style="text-align: center; padding: 15px; background: var(--color-danger); color: white; border-radius: 10px;">
                <div style="font-size: 24px; font-weight: 600;">${this.questions.length - this.score}</div>
                <div>Incorrect</div>
              </div>
              <div style="text-align: center; padding: 15px; background: var(--color-primary); color: white; border-radius: 10px;">
                <div style="font-size: 24px; font-weight: 600;">${this.questions.length}</div>
                <div>Total</div>
              </div>
            </div>
            <button onclick="customQuizApp.showDetailedResults()" class="btn-secondary" style="margin-right: 10px;">View Details</button>
            <button onclick="customQuizApp.showQuizSetup()" class="btn-primary">Create New Quiz</button>
          </div>
        `;
        
        this.resultsContainer.classList.remove('hidden');
        this.quizContainer.style.display = 'none';
        this.quizControls.style.display = 'none';
        this.progressContainer.style.display = 'none';
        this.progressText.style.display = 'none';
      }

      showDetailedResults() {
        let detailsHtml = '<div class="card"><h3>Detailed Results</h3>';
        
        for (let i = 0; i < this.questions.length; i++) {
          const question = this.questions[i];
          const userAnswer = this.userAnswers[i] || 'Not answered';
          const isCorrect = userAnswer === question.answer;
          
          detailsHtml += `
            <div style="margin-bottom: 20px; padding: 15px; border-left: 4px solid ${isCorrect ? 'var(--color-success)' : 'var(--color-danger)'}; background: var(--color-border);">
              <div style="font-weight: 600; margin-bottom: 10px;">Question ${i + 1}: ${question.question}</div>
              <div style="margin-bottom: 5px;">Your answer: <span style="color: ${isCorrect ? 'var(--color-success)' : 'var(--color-danger)'}; font-weight: 600;">${userAnswer}</span></div>
              <div>Correct answer: <span style="color: var(--color-success); font-weight: 600;">${question.answer}</span></div>
            </div>
          `;
        }
        
        detailsHtml += '<button onclick="customQuizApp.displayResults()" class="btn-secondary">Back to Summary</button></div>';
        this.resultsContainer.innerHTML = detailsHtml;
      }

      resetQuiz() {
        if (confirm('Are you sure you want to reset the quiz? All progress will be lost.')) {
          this.startQuiz();
        }
      }
    }

    // Initialize the custom quiz app
    let customQuizApp;
    document.addEventListener('DOMContentLoaded', () => {
      customQuizApp = new CustomQuizApp();
    });
  </script>
  
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none !important;
    }
  </style>
</body>
</html>